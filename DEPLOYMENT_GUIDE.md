# ðŸ“¦ Deployment Guide - Room Separation Fix\n\n## Pre-Deployment Checklist\n\n### Code Review\n- [x] Server code reviewed and verified\n- [x] Client code reviewed and verified  \n- [x] No breaking changes for users\n- [x] Backward compatibility: defaults to 'chat'\n- [x] Error handling in place\n- [x] Logging updated appropriately\n\n### Testing (Local)\n- [x] Syntax validation (Node.js)\n- [x] Dart compilation (no errors)\n- [x] Logic review (correct queue separation)\n- [x] Edge case review (disconnect, next, etc)\n\n---\n\n## Deployment Steps\n\n### Step 1: Backup Current Server\n```bash\n# On server machine\ncd /path/to/lolserver\ncp ws_server.js ws_server.js.backup\ncp package.json package.json.backup\n```\n\n### Step 2: Deploy New Server Code\n```bash\n# Option A: Direct file replacement\ncp /path/to/new/ws_server.js /path/to/lolserver/ws_server.js\n\n# Option B: Git pull\ncd /path/to/lolserver\ngit pull origin main\n```\n\n### Step 3: Verify Dependencies\n```bash\ncd /path/to/lolserver\nnpm install\n# Should show: no new packages needed (only require, http, socket.io, express)\n```\n\n### Step 4: Restart Server\n```bash\n# Option A: Kill and restart\npkill -f \"node ws_server.js\"\nsleep 2\nnode ws_server.js\n\n# Option B: Using PM2 (if installed)\npm2 restart ws_server\n\n# Option C: Using systemd\nsudo systemctl restart omeglelol-server\n```\n\n### Step 5: Verify Server is Running\n```bash\n# Check if listening on port 3000\nnetstat -tuln | grep 3000\n# Should show: tcp 0 0 0.0.0.0:3000 0.0.0.0:* LISTEN\n\n# Check logs\nnode ws_server.js\n# Should see: \"Server running on port 3000\"\n```\n\n### Step 6: Deploy Flutter Client\n```bash\n# Build release APK (Android)\ncd /path/to/omeglelol\nflutter build apk --release\n\n# Build release IPA (iOS)\nflutter build ios --release\n\n# Build for Web\nflutter build web --release\n\n# Build for Windows\nflutter build windows --release\n```\n\n### Step 7: Push New Build\n```bash\n# Android: Upload to Play Store\n# iOS: Upload to App Store  \n# Web: Deploy to hosting\n# Windows: Update installer\n```\n\n---\n\n## Rollback Plan (If Needed)\n\n### Quick Rollback (< 5 minutes downtime)\n```bash\n# Restore from backup\ncp ws_server.js.backup ws_server.js\n\n# Restart server\npkill -f \"node ws_server.js\"\nnode ws_server.js\n\n# Verify\nnetstat -tuln | grep 3000\n```\n\n### Client Rollback\n- Users will have old app version on their devices\n- They'll continue using old matching behavior\n- When they update, they'll get new behavior\n- No data loss or corruption\n\n---\n\n## Post-Deployment Verification\n\n### Server Verification\n```bash\n# Check server is running\nps aux | grep \"node ws_server\"\n\n# Check port is listening\nnetstat -tuln | grep 3000\n\n# Monitor logs (let it run for 5-10 minutes)\nnode ws_server.js\n\n# Should see connection messages like:\n# connected: socket_id_1\n# socket_id_1 queued for chat pairing\n# connected: socket_id_2\n# Matched socket_id_1 with socket_id_2 in room_chat_socket_id_1_socket_id_2 (chat)\n```\n\n### Client Verification (Android/iOS)\n```\n1. Install new app version\n2. Open ChatRoom\n3. Verify: \"Searching for a partner...\" message\n4. Open different browser tab with VideoChatRoom\n5. Verify: No match happens (different types)\n6. Get another user in ChatRoom\n7. Verify: Matched within 10 seconds\n8. Click \"Next\" button\n9. Verify: New partner found from chat queue only\n```\n\n### Web Client Verification\n1. Navigate to app URL\n2. Clear cache/cookies (Ctrl+Shift+Del)\n3. Open ChatRoom\n4. Verify matching works\n5. Test video chat separately\n\n---\n\n## Monitoring After Deployment\n\n### Key Metrics to Track\n\n#### Server Logs\n```\nâœ“ Number of \"connected\" messages (healthy connections)\nâœ“ Number of \"Matched\" messages (successful pairings)\nâœ“ Queued messages showing \"(chat)\" and \"(video)\" types\nâœ“ No error messages\n```\n\n#### User Experience\n```\nâœ“ Chat users match with chat users only\nâœ“ Video users match with video users only\nâœ“ Average match time: < 10 seconds\nâœ“ Next button works immediately\nâœ“ Disconnection notifications work\n```\n\n#### Server Performance\n```\nâœ“ CPU usage: < 5%\nâœ“ Memory: < 100MB\nâœ“ Connection handling: smooth\nâœ“ No crashes or restarts\n```\n\n### Monitoring Setup (Recommended)\n\n#### Using PM2\n```bash\nnpm install -g pm2\ncd /path/to/lolserver\npm2 start ws_server.js --name \"omeglelol-server\"\npm2 monit  # Real-time monitoring\npm2 logs   # View logs\n```\n\n#### Using Systemd\n```bash\n# Create /etc/systemd/system/omeglelol-server.service\n[Unit]\nDescription=OmegLeLOL WebSocket Server\nAfter=network.target\n\n[Service]\nType=simple\nUser=nodejs\nWorkingDirectory=/home/nodejs/omeglelol-server\nExecStart=/usr/bin/node ws_server.js\nRestart=always\nRestartSec=10\n\n[Install]\nWantedBy=multi-user.target\n\n# Enable and start\nsudo systemctl enable omeglelol-server\nsudo systemctl start omeglelol-server\nsudo systemctl status omeglelol-server\n```\n\n---\n\n## Troubleshooting Post-Deployment\n\n### Issue 1: Users not matching\n**Check**:\n1. Server logs showing correct chatType\n2. Client sending {type: 'chat'} or {type: 'video'}\n3. Server console shows users in correct queue\n\n**Solution**:\n- Verify client build was updated\n- Check server is actually running new code (check timestamps: `ls -la ws_server.js`)\n- Restart server if needed\n\n### Issue 2: Slow matching\n**Check**:\n1. How many users in each queue (monitor logs)\n2. Server CPU/Memory usage\n3. Network latency\n\n**Solution**:\n- Normal: < 10 seconds with 2+ users\n- If > 20 seconds: might be low user count\n- If stuck: restart server\n\n### Issue 3: Cross-type matching\n**Check**:\n1. Verify userTypeMap is set correctly\n2. Check room name format: should include type\n3. Monitor logs for type mismatches\n\n**Solution**:\n- Rollback to ws_server.js.backup immediately\n- Verify code was deployed correctly\n- Check git diff to ensure changes are present\n\n### Issue 4: Multiple peers in room\n**Check**:\n1. Room name format (should be: room_chat_id1_id2)\n2. Peer verification logic\n\n**Solution**:\n- This shouldn't happen with new code\n- If it does: immediate rollback\n- Check for code deployment issues\n\n---\n\n## Communication Plan\n\n### Pre-Deployment (24-48 hours before)\n```\nMessage to users:\n\"We're improving the matching system tomorrow at [TIME] UTC. \nChatroom and Video Chat users will now match separately for \nbetter experience. You may notice slight downtime (< 5 min).\n```\n\n### During Deployment\n```\nMessage to users:\n\"Maintenance in progress. Service will be back online shortly.\"\n```\n\n### Post-Deployment\n```\nMessage to users:\n\"Matching system improved! Chat and Video Chat users now match \nseparately. Video calls now only with other video users. \nEnjoy better connections!\"\n```\n\n---\n\n## Success Criteria\n\nâœ… Server starts without errors  \nâœ… Connections are accepted  \nâœ… Chat users match only with chat users  \nâœ… Video users match only with video users  \nâœ… No users match across types  \nâœ… Next button searches within same type  \nâœ… Disconnect handling works  \nâœ… Average match time: < 10 seconds  \nâœ… No crashes or memory leaks  \nâœ… Users report better experience  \n\n---\n\n## Timeline\n\n| Task | Duration | Responsibility |\n|------|----------|----------------|\n| Backup | 2 min | DevOps |\n| Deploy Server | 3 min | DevOps |\n| Verify Server | 5 min | DevOps |\n| Deploy Clients | 30 min | DevOps/Team |\n| Verify Clients | 10 min | QA |\n| Monitor | 1-2 hours | DevOps |\n| **Total** | **~1 hour** | |\n\n---\n\n## Emergency Contacts\n\n- **DevOps Lead**: [Contact]\n- **Backend Dev**: [Contact]\n- **App Dev**: [Contact]\n- **QA Lead**: [Contact]\n\n---\n\n## Sign-off\n\n- [ ] Code review completed\n- [ ] Testing completed\n- [ ] Backup created\n- [ ] Deployment script ready\n- [ ] Team notified\n- [ ] Ready to deploy\n\n**Approved by**: _______________  \n**Date**: _______________  \n**Time**: _______________  \n\n---\n\n**Last Updated**: January 19, 2026  \n**Status**: Ready for Deployment âœ…\n"